version: "3"
services:
  backend:
    restart: no
    container_name: beachwoodfinancial_development_webapp
    environment:
      - TERM=xterm-256color
      - COLOR_PROMPT=yes
      - LANG=C.UTF-8
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - NODE_ENV=development
      - PIP_PROGRESS_BAR=on
    tty: true
    stdin_open: true
    build:
      context: ./
      dockerfile: ./docker/django/Dockerfile
      args:
        BUILD_ENV: development
        progress: plain
    working_dir: /beachwoodfinancial_development/src
    ports:
      - "8000:8000"  # Expose port 8000 for Nginx to forward traffic
    volumes:
      - ./staticfiles:/beachwoodfinancial_development/src/staticfiles  # Bind static folder
      - ./media:/beachwoodfinancial_development/src/media              # Bind media folder
      - type: bind
        source: .
        target: /beachwoodfinancial_development:z
    env_file:
      - ./src/.env/.env_docker
    command: /start
    depends_on:
      - db
      - cache

  db:
    image: postgres:alpine
    tty: true
    stdin_open: true
    container_name: beachwoodfinancial_development_db
    ports:
      - "5433:5432"
    expose:
      - "5432"
    volumes:
      - pgdata:/var/lib/postgresql/data:Z
    environment:
      - TERM=xterm-256color
      - COLOR_PROMPT=yes
      - LANG=C.UTF-8
      - POSTGRES_USER=postgres
      - POSTGRES_DB=beachwoodfinancial_development
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_HOST_AUTH_METHOD=trust

  cache:
    restart: always
    container_name: beachwoodfinancial_development_cache
    ports:
      - "6379:6379"
    image: valkey/valkey  # Keeping your custom Redis image
    expose:
      - 6379
    environment:
      - TERM=xterm-256color
      - COLOR_PROMPT=yes
      - LANG=C.UTF-8

  nginx:
    image: nginx:latest
    build:
      context: .
      dockerfile: ./docker/nginx/Dockerfile
    ports:
      - "80:80"
    volumes:
      - ./staticfiles:/home/static/staticfiles  # Bind static files
      - ./media:/home/media/media               # Bind media files
    depends_on:
      - backend
      - db
      - cache  # Added db and cache dependencies
    environment:
      - TERM=xterm-256color
      - COLOR_PROMPT=yes
      - LANG=C.UTF-8

  cloudflaretunnel:
    image: cloudflare/cloudflared:latest
    entrypoint: [ "cloudflared", "tunnel", "--no-autoupdate", "run", "--token", "$CLOUDFLARE_TUNNEL_TOKEN" ]
    env_file:
      - ./src/.env/.env_cloudflare
    networks:
      - hosting_network

networks:
  hosting_network:

volumes:
  pgdata:
  staticfiles:
  mediafiles:
